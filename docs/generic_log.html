<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generic Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-xl mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Log Entry</h1>
    <div id="formContainer"></div>
    <div class="text-center mt-4">
      <button onclick="saveEntry()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save Entry</button>
    </div>
    <div class="text-center mt-2">
      <button onclick="resetLog()" class="text-red-500 text-sm mt-2">Reset This Log</button>
    </div>
    <hr class="my-4">
    <h2 class="font-semibold mb-2">Previous Entries</h2>
    <div id="logEntries" class="bg-gray-200 p-4 rounded"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com",
      messagingSenderId: "420151664852",
      appId: "1:420151664852:web:e4c0a3429b04b359aad195"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    let fields = [];
    let templateName = "";

    function loadTemplate() {
      db.ref(`qr_codes/${id}`).once("value").then(snap => {
        const templateKey = snap.val();
        if (!templateKey) return;

        db.ref(`templates/${templateKey}`).once("value").then(templateSnap => {
          const data = templateSnap.val();
          const rawFields = data.fields || [];
          fields = Array.isArray(rawFields) ? rawFields : Object.values(rawFields);
          templateName = templateKey;
          renderForm();
          loadEntries();
        });
      });
    }

    function renderForm() {
      const container = document.getElementById("formContainer");
      container.innerHTML = "";
      fields.forEach((field, index) => {
        const label = field.name || `Unnamed Field ${index}`;
        container.innerHTML += `
          <label class="block font-medium mt-2">${label}</label>
          <input type="text" id="field${index}" class="w-full p-2 border rounded" />
        `;
      });
    }

    function saveEntry() {
      const entry = {};
      fields.forEach((_, index) => {
        const input = document.getElementById(`field${index}`);
        entry[`field${index}`] = input.value;
      });
      entry.timestamp = new Date().toISOString();
      db.ref(`logs/${id}`).push(entry).then(loadEntries);
    }

    function loadEntries() {
      db.ref(`logs/${id}`).once("value").then(snap => {
        const container = document.getElementById("logEntries");
        container.innerHTML = "";
        const entries = snap.val();
        if (!entries) return;
        Object.values(entries).forEach(entry => {
          Object.values(entry).forEach(val => {
            container.innerHTML += `<div>${val}</div>`;
          });
          container.innerHTML += `<hr class='my-2'>`;
        });
      });
    }

    function resetLog() {
      db.ref(`logs/${id}`).remove();
      db.ref(`qr_codes/${id}`).remove();
      location.href = "index.html?id=" + id;
    }

    loadTemplate();
  </script>
</body>
</html>
