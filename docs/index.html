<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Car Maintenance Log</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Car Maintenance Log</h1>
    <p class="text-sm text-gray-500 mb-4" id="loading-state">Checking status...</p>

    <div id="vehicle-summary" class="mb-6 hidden">
      <div class="bg-white p-4 shadow rounded">
        <h2 class="text-xl font-semibold" id="vehicle-text"></h2>
        <p class="text-sm text-gray-500">User ID: <span id="user-id" class="font-mono"></span></p>
        <button id="edit-vehicle" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Edit</button>
      </div>
    </div>

    <div id="vehicle-form" class="mb-6 hidden">
      <div class="bg-white p-4 shadow rounded">
        <h2 class="text-xl font-semibold mb-2">Enter Vehicle Info</h2>
        <input id="make" placeholder="Make" class="w-full mb-2 p-2 border rounded" />
        <input id="model" placeholder="Model" class="w-full mb-2 p-2 border rounded" />
        <input id="year" placeholder="Year" class="w-full mb-2 p-2 border rounded" />
        <input id="plate" placeholder="Plate" class="w-full mb-2 p-2 border rounded" />
        <button id="save-vehicle" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Save</button>
      </div>
    </div>

    <div class="bg-white p-4 shadow rounded mb-6">
      <h2 class="text-xl font-semibold mb-2">New Maintenance Entry</h2>
      <select id="type" class="w-full mb-2 p-2 border rounded">
        <option>Oil Change</option>
        <option>Tire Rotation</option>
        <option>Brake Inspection</option>
        <option>Battery Replacement</option>
      </select>
      <input id="note" placeholder="Notes" class="w-full mb-2 p-2 border rounded" />
      <input id="cost" type="number" placeholder="Cost (e.g. 45.99)" class="w-full mb-2 p-2 border rounded" />
      <button id="add-entry" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">Add Entry</button>
    </div>

    <div class="bg-white p-4 shadow rounded">
      <h2 class="text-xl font-semibold mb-2">History</h2>
      <ul id="entry-list" class="space-y-2"></ul>
    </div>

    <div class="text-center mt-6">
      <button id="reset-btn" class="text-red-600 font-semibold">Reset Page (This will erase all previous data)</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com",
      messagingSenderId: "277809008742",
      appId: "1:277809008742:web:2586a2b821d8da8f969da7",
      measurementId: "G-X7ZQ6DJYEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const rootRef = ref(db, `qr_codes/${id}`);

    const loading = document.getElementById("loading-state");
    const vehicleSummary = document.getElementById("vehicle-summary");
    const vehicleText = document.getElementById("vehicle-text");
    const userIdSpan = document.getElementById("user-id");
    const editVehicleBtn = document.getElementById("edit-vehicle");
    const vehicleForm = document.getElementById("vehicle-form");
    const saveVehicleBtn = document.getElementById("save-vehicle");
    const makeInput = document.getElementById("make");
    const modelInput = document.getElementById("model");
    const yearInput = document.getElementById("year");
    const plateInput = document.getElementById("plate");

    const type = document.getElementById("type");
    const note = document.getElementById("note");
    const cost = document.getElementById("cost");
    const addEntry = document.getElementById("add-entry");
    const entryList = document.getElementById("entry-list");
    const resetBtn = document.getElementById("reset-btn");

    onValue(rootRef, (snapshot) => {
      const data = snapshot.val() || {};
      loading.textContent = "";

      if (data.vehicle) {
        vehicleText.textContent = `${data.vehicle.year || ""} ${data.vehicle.make || ""} ${data.vehicle.model || ""} (Plate: ${data.vehicle.plate || ""})`;
        userIdSpan.textContent = id;
        vehicleSummary.classList.remove("hidden");
        vehicleForm.classList.add("hidden");
      } else {
        vehicleSummary.classList.add("hidden");
        vehicleForm.classList.remove("hidden");
      }

      entryList.innerHTML = "";
      if (data.entries) {
        const sorted = Object.entries(data.entries).sort((a, b) => b[1].timestamp - a[1].timestamp);
        sorted.forEach(([key, entry]) => {
          const li = document.createElement("li");
          li.className = "border p-2 rounded";
          li.innerHTML = `<strong>${entry.type}</strong> - ${entry.note || ""} - $${entry.cost.toFixed(2)} <br/><small>${new Date(entry.timestamp).toLocaleString()}</small>`;
          entryList.appendChild(li);
        });
      }
    });

    saveVehicleBtn.onclick = () => {
      const vehicle = {
        make: makeInput.value,
        model: modelInput.value,
        year: yearInput.value,
        plate: plateInput.value
      };
      set(rootRef, { vehicle });
    };

    editVehicleBtn.onclick = () => {
      vehicleSummary.classList.add("hidden");
      vehicleForm.classList.remove("hidden");
    };

    addEntry.onclick = () => {
      const newRef = push(ref(db, `qr_codes/${id}/entries`));
      set(newRef, {
        type: type.value,
        note: note.value,
        cost: parseFloat(cost.value) || 0,
        timestamp: Date.now()
      });
      note.value = "";
      cost.value = "";
      type.value = "Oil Change";
    };

    resetBtn.onclick = () => {
      if (confirm("Are you sure you want to erase everything?")) {
        set(rootRef, {});
      }
    };
  </script>
</body>
</html>
