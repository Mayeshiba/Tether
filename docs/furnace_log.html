<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Furnace Log</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
    .log-entry {
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
    }
    .timestamp {
      font-size: 0.8em;
      color: gray;
    }
  </style>
</head>
<body>
  <h1>Furnace Service Log</h1>
  <p><strong>ID:</strong> <span id="qrId">Loading...</span></p>

  <textarea id="logText" placeholder="Describe the service performed, inspection notes, etc..."></textarea>
  <button onclick="addEntry()">Add Entry</button>

  <h2>History</h2>
  <div id="logList">Loading log...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9A-wvRUMrxQ7_25D-2XYaW9_Nt7eybWo",
      authDomain: "qr-sticker-demo.firebaseapp.com",
      databaseURL: "https://qr-sticker-demo-default-rtdb.firebaseio.com",
      projectId: "qr-sticker-demo",
      storageBucket: "qr-sticker-demo.appspot.com",
      messagingSenderId: "787247635596",
      appId: "1:787247635596:web:946fb94a38360fc7ac6c77"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const qrIdEl = document.getElementById("qrId");
    const logList = document.getElementById("logList");

    if (!id) {
      qrIdEl.textContent = "Missing QR code ID.";
      logList.textContent = "";
    } else {
      qrIdEl.textContent = id;
      loadLogs();
    }

    function addEntry() {
      const text = document.getElementById("logText").value.trim();
      if (!text) return alert("Please enter service details.");

      const entryRef = ref(db, `qrCodes/${id}/log`);
      push(entryRef, {
        text: text,
        timestamp: Date.now()
      }).then(() => {
        document.getElementById("logText").value = "";
        loadLogs();
      });
    }

    function loadLogs() {
      const entryRef = ref(db, `qrCodes/${id}/log`);
      get(entryRef).then(snapshot => {
        logList.innerHTML = "";
        if (snapshot.exists()) {
          const entries = snapshot.val();
          const sorted = Object.values(entries).sort((a, b) => b.timestamp - a.timestamp);
          for (const entry of sorted) {
            const div = document.createElement("div");
            div.className = "log-entry";
            const date = new Date(entry.timestamp).toLocaleString();
            div.innerHTML = `<div class="timestamp">${date}</div><div>${entry.text}</div>`;
            logList.appendChild(div);
          }
        } else {
          logList.textContent = "No furnace service entries yet.";
        }
      });
    }
  </script>
</body>
</html>
