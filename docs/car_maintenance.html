<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car Maintenance Log</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    input, select, button { margin: 0.5rem; }
    #vehicle-info { margin-top: 1rem; }
    #entry-list li { margin-top: 0.25rem; }
  </style>
</head>
<body>
  <h1>Car Maintenance Log</h1>
  <div id="vehicle-summary"></div>
  <button id="edit-vehicle-btn" style="display:none;">Edit Vehicle Info</button>
  <button id="add-vehicle-btn" style="display:none;">Add Vehicle Info</button>

  <div id="vehicle-info" style="display:none;">
    <label>Make: <input id="make" /></label><br />
    <label>Model: <input id="model" /></label><br />
    <label>Year: <input id="year" /></label><br />
    <label>Plate Number: <input id="plate" /></label><br />
    <button onclick="saveVehicleInfo()">Save Vehicle Info</button>
  </div>

  <div id="log-form">
    <select id="maintenance-type">
      <option value="Oil Change">Oil Change</option>
      <option value="Tire Rotation">Tire Rotation</option>
      <option value="Brake Inspection">Brake Inspection</option>
      <option value="Battery Replacement">Battery Replacement</option>
      <option value="Other">Other</option>
    </select>
    <input id="note" placeholder="Notes" />
    <input id="cost" placeholder="Cost (e.g. 45.99)" />
    <button id="add-entry-btn">Add Entry</button>
  </div>

  <ul id="entry-list"></ul>

  <button id="reset-btn" onclick="resetQRCode()" style="margin-top: 3rem; color: red;">
    Reset Page (This will erase all previous data)
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com",
      messagingSenderId: "277809008742",
      appId: "1:277809008742:web:2586a2b821d8da8f969da7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    if (!id) throw new Error("Missing ID");

    const entryList = document.getElementById("entry-list");
    const makeEl = document.getElementById("make");
    const modelEl = document.getElementById("model");
    const yearEl = document.getElementById("year");
    const plateEl = document.getElementById("plate");
    const vehicleInfoDiv = document.getElementById("vehicle-info");
    const vehicleSummary = document.getElementById("vehicle-summary");
    const editVehicleBtn = document.getElementById("edit-vehicle-btn");
    const addVehicleBtn = document.getElementById("add-vehicle-btn");

    const vehicleRef = ref(db, `qr_codes/${id}/vehicle`);
    get(vehicleRef).then(snapshot => {
      const data = snapshot.val();
      if (data) {
        makeEl.value = data.make || "";
        modelEl.value = data.model || "";
        yearEl.value = data.year || "";
        plateEl.value = data.plate || "";
        displayVehicleSummary(data);
        editVehicleBtn.style.display = "inline-block";
      } else {
        addVehicleBtn.style.display = "inline-block";
      }
    });

    editVehicleBtn.addEventListener("click", () => {
      vehicleSummary.innerHTML = "";
      vehicleInfoDiv.style.display = "block";
    });

    addVehicleBtn.addEventListener("click", () => {
      vehicleSummary.innerHTML = "";
      vehicleInfoDiv.style.display = "block";
    });

    function displayVehicleSummary(info) {
      vehicleSummary.innerHTML = `<strong>${info.year} ${info.make} ${info.model}</strong> (Plate: ${info.plate})`;
    }

    function saveVehicleInfo() {
      const info = {
        make: makeEl.value,
        model: modelEl.value,
        year: yearEl.value,
        plate: plateEl.value
      };
      set(vehicleRef, info).then(() => {
        displayVehicleSummary(info);
        vehicleInfoDiv.style.display = "none";
        editVehicleBtn.style.display = "inline-block";
        addVehicleBtn.style.display = "none";
      });
    }

    const entriesRef = ref(db, `qr_codes/${id}/entries`);
    function loadEntries() {
      get(entriesRef).then(snapshot => {
        entryList.innerHTML = "";
        const entries = snapshot.val();
        if (entries) {
          Object.values(entries).forEach(displayEntry);
        }
      });
    }

    function displayEntry(entry) {
      const li = document.createElement("li");
      li.textContent = `${entry.timestamp}: ${entry.type} - ${entry.note} ($${entry.cost})`;
      entryList.appendChild(li);
    }

    document.getElementById("add-entry-btn").addEventListener("click", () => {
      const type = document.getElementById("maintenance-type").value;
      const note = document.getElementById("note").value;
      const cost = document.getElementById("cost").value || "0.00";
      const timestamp = new Date().toLocaleString();

      const newEntry = { timestamp, type, note, cost };

      push(entriesRef, newEntry).then(() => {
        loadEntries();
        document.getElementById("note").value = "";
        document.getElementById("cost").value = "";
      });
    });

    function resetQRCode() {
      if (confirm("Are you sure you want to reset this page? This will erase all previous data.")) {
        remove(ref(db, `qr_codes/${id}`)).then(() => {
          window.location.href = `../index.html?id=${id}`;
        });
      }
    }

    loadEntries();
  </script>
</body>
</html>
