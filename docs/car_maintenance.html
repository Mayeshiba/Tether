<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Car Maintenance Log</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <h1>Car Maintenance Log</h1>
  <div id="vehicle-summary" style="margin-bottom: 1rem;"></div>
  <button id="edit-vehicle-btn">Edit Vehicle Info</button>

  <div id="vehicle-info" style="display:none;">
    <label>Make: <input id="make" type="text" /></label>
    <label>Model: <input id="model" type="text" /></label>
    <label>Year: <input id="year" type="text" /></label>
    <label>Plate Number: <input id="plate" type="text" /></label>
    <button onclick="saveVehicleInfo()">Save Vehicle Info</button>
  </div>

  <div id="log-form">
    <select id="maintenance-type">
      <option value="Oil Change">Oil Change</option>
      <option value="Tire Rotation">Tire Rotation</option>
      <option value="Brake Inspection">Brake Inspection</option>
      <option value="Battery Replacement">Battery Replacement</option>
      <option value="Other">Other</option>
    </select>
    <input id="note" placeholder="Notes" />
    <input id="cost" placeholder="Cost" type="number" step="0.01" />
    <button id="add-entry-btn">Add Entry</button>
  </div>

  <ul id="entry-list"></ul>

  <button id="reset-btn" onclick="resetQRCode()" style="margin-top: 3rem; color: red;">
    Reset Page (This will erase all previous data)
  </button>

  <script type="module">
    import { db, ref, get, set, push, remove } from "../assets/js/firebase-init.js";

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const entryList = document.getElementById("entry-list");

    const makeEl = document.getElementById("make");
    const modelEl = document.getElementById("model");
    const yearEl = document.getElementById("year");
    const plateEl = document.getElementById("plate");
    const vehicleInfoDiv = document.getElementById("vehicle-info");
    const vehicleSummary = document.getElementById("vehicle-summary");
    const editVehicleBtn = document.getElementById("edit-vehicle-btn");

    const vehicleRef = ref(db, `qr_codes/${id}/vehicle`);
    get(vehicleRef).then(snapshot => {
      const data = snapshot.val();
      if (data) {
        makeEl.value = data.make || "";
        modelEl.value = data.model || "";
        yearEl.value = data.year || "";
        plateEl.value = data.plate || "";
        displayVehicleSummary(data);
      } else {
        vehicleInfoDiv.style.display = "block";
      }
    });

    editVehicleBtn.addEventListener("click", () => {
      vehicleInfoDiv.style.display = "block";
    });

    function displayVehicleSummary(info) {
      vehicleSummary.innerHTML = `<strong>${info.year} ${info.make} ${info.model}</strong> (Plate: ${info.plate})`;
    }

    function saveVehicleInfo() {
      const info = {
        make: makeEl.value,
        model: modelEl.value,
        year: yearEl.value,
        plate: plateEl.value
      };
      set(vehicleRef, info).then(() => {
        displayVehicleSummary(info);
        vehicleInfoDiv.style.display = "none";
      });
    }

    const entriesRef = ref(db, `qr_codes/${id}/entries`);
    function loadEntries() {
      get(entriesRef).then(snapshot => {
        const entries = snapshot.val();
        if (entries) {
          entryList.innerHTML = "";
          Object.entries(entries).forEach(([key, entry]) => {
            displayEntry(entry);
          });
        }
      });
    }

    document.getElementById("add-entry-btn").addEventListener("click", () => {
      const type = document.getElementById("maintenance-type").value;
      const note = document.getElementById("note").value;
      const cost = document.getElementById("cost").value;
      const timestamp = new Date().toLocaleString();

      const newEntry = {
        timestamp,
        type,
        note,
        cost
      };

      push(entriesRef, newEntry)
        .then(() => {
          loadEntries();
          document.getElementById("note").value = "";
          document.getElementById("cost").value = "";
        })
        .catch((error) => {
          console.error("Error saving entry:", error);
        });
    });

    function displayEntry(entry) {
      const li = document.createElement("li");
      li.textContent = `${entry.timestamp}: ${entry.type} - ${entry.note} ($${entry.cost})`;
      entryList.appendChild(li);
    }

    function resetQRCode() {
      if (confirm("Are you sure you want to reset this page? This will erase all previous data.")) {
        remove(ref(db, `qr_codes/${id}`)).then(() => {
          window.location.href = `../index.html?id=${id}`;
        });
      }
    }

    loadEntries();
  </script>
</body>
</html>
