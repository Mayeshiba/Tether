<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Car Maintenance Log</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <h1>Car Maintenance Log</h1>
  <div id="vehicle-summary" style="margin-bottom: 1rem;"></div>
  <button id="edit-vehicle-btn" style="display:none;">Edit Vehicle Info</button>
  <button id="add-vehicle-btn" style="display:none;">Add Vehicle Info</button>

  <div id="vehicle-info" style="display:none;">
    <label>Make: <input id="make" type="text" /></label><br>
    <label>Model: <input id="model" type="text" /></label><br>
    <label>Year: <input id="year" type="text" /></label><br>
    <label>Plate Number: <input id="plate" type="text" /></label><br>
    <button id="save-vehicle">Save Vehicle Info</button>
  </div>

  <div id="log-form">
    <select id="maintenance-type">
      <option value="Oil Change">Oil Change</option>
      <option value="Tire Rotation">Tire Rotation</option>
      <option value="Brake Inspection">Brake Inspection</option>
      <option value="Battery Replacement">Battery Replacement</option>
      <option value="Other">Other</option>
    </select>
    <input id="note" placeholder="Notes" />
    <input id="cost" placeholder="Cost" type="text" />
    <button id="add-entry-btn">Add Entry</button>
  </div>

  <ul id="entry-list"></ul>

  <button id="reset-btn" style="margin-top: 3rem; color: red;">Reset Page (This will erase all previous data)</button>

  <script type="module">
    import { db, ref, get, set, push, remove } from "../assets/js/firebase-init.js";

    const id = new URLSearchParams(window.location.search).get("id");
    if (!id) {
      alert("No ID found in URL.");
      throw new Error("Missing QR code ID.");
    }

    const entryList = document.getElementById("entry-list");
    const makeEl = document.getElementById("make");
    const modelEl = document.getElementById("model");
    const yearEl = document.getElementById("year");
    const plateEl = document.getElementById("plate");
    const vehicleSummary = document.getElementById("vehicle-summary");
    const editBtn = document.getElementById("edit-vehicle-btn");
    const addBtn = document.getElementById("add-vehicle-btn");
    const vehicleDiv = document.getElementById("vehicle-info");

    const vehicleRef = ref(db, `qr_codes/${id}/vehicle`);
    const entriesRef = ref(db, `qr_codes/${id}/entries`);

    async function loadVehicle() {
      const snapshot = await get(vehicleRef);
      const data = snapshot.val();
      if (data) {
        displayVehicle(data);
        makeEl.value = data.make;
        modelEl.value = data.model;
        yearEl.value = data.year;
        plateEl.value = data.plate;
        editBtn.style.display = "inline-block";
      } else {
        addBtn.style.display = "inline-block";
      }
    }

    function displayVehicle(data) {
      vehicleSummary.innerHTML = `<strong>${data.year} ${data.make} ${data.model}</strong> (Plate: ${data.plate})`;
    }

    document.getElementById("save-vehicle").addEventListener("click", async () => {
      const data = {
        make: makeEl.value,
        model: modelEl.value,
        year: yearEl.value,
        plate: plateEl.value
      };
      await set(vehicleRef, data);
      vehicleDiv.style.display = "none";
      displayVehicle(data);
      addBtn.style.display = "none";
      editBtn.style.display = "inline-block";
    });

    editBtn.addEventListener("click", () => {
      vehicleDiv.style.display = "block";
    });

    addBtn.addEventListener("click", () => {
      vehicleDiv.style.display = "block";
    });

    async function loadEntries() {
      const snapshot = await get(entriesRef);
      const data = snapshot.val();
      entryList.innerHTML = "";
      if (data) {
        Object.values(data).forEach(displayEntry);
      }
    }

    function displayEntry(entry) {
      const li = document.createElement("li");
      li.textContent = `${entry.timestamp}: ${entry.type} - ${entry.note} ($${entry.cost})`;
      entryList.appendChild(li);
    }

    document.getElementById("add-entry-btn").addEventListener("click", async () => {
      const entry = {
        timestamp: new Date().toLocaleString(),
        type: document.getElementById("maintenance-type").value,
        note: document.getElementById("note").value,
        cost: document.getElementById("cost").value || "0.00"
      };
      await push(entriesRef, entry);
      document.getElementById("note").value = "";
      document.getElementById("cost").value = "";
      loadEntries();
    });

    document.getElementById("reset-btn").addEventListener("click", async () => {
      if (confirm("This will erase all data for this QR code. Proceed?")) {
        await remove(ref(db, `qr_codes/${id}`));
        window.location.href = `../index.html?id=${id}`;
      }
    });

    loadVehicle();
    loadEntries();
  </script>
</body>
</html>
