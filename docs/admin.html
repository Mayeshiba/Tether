<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Manage Templates & QR Codes</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen p-4">
  <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <!-- Button to return to the main page -->
    <div class="mb-6 text-left">
      <a href="./index.html" class="inline-block px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
        &larr; Back to Main Page
      </a>
    </div>

    <h1 class="text-3xl font-bold mb-8 text-center text-blue-700">Admin Panel</h1>

    <!-- Section for Creating New Templates -->
    <div class="mb-10 p-6 border border-blue-200 rounded-lg bg-blue-50">
      <h2 class="text-2xl font-semibold mb-6 text-blue-600">Create New Template</h2>
      <form id="new-template-form" class="space-y-4">
        <div>
          <label for="template-label" class="block text-lg font-medium text-gray-700">Display Label (e.g., Car Maintenance Log):</label>
          <input type="text" id="template-label" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="User-friendly name for the template">
        </div>

        <h3 class="text-xl font-medium mt-6 mb-4 text-gray-700">Template Fields:</h3>
        <div id="template-fields-container" class="space-y-4 border p-4 rounded-md bg-white">
          <!-- Dynamic fields will be added here -->
        </div>
        <button type="button" id="add-field-btn" class="mt-4 px-6 py-3 bg-green-500 text-white font-semibold rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
          Add New Field
        </button>

        <button type="submit" class="mt-8 w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          Save New Template
        </button>
        <p id="new-template-status" class="mt-4 text-center text-sm text-gray-600"></p>
      </form>
    </div>

    <!-- NEW: Section for Configuring QR Codes -->
    <div class="mb-10 p-6 border border-purple-200 rounded-lg bg-purple-50">
      <h2 class="text-2xl font-semibold mb-6 text-purple-600">Configure QR Code</h2>
      <form id="configure-qr-form" class="space-y-4">
        <div>
          <label for="qr-id-input" class="block text-lg font-medium text-gray-700">QR Code ID:</label>
          <input type="text" id="qr-id-input" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Unique ID from your QR code (e.g., wine_bottle_001)">
        </div>
        
        <div>
          <label for="qr-template-select" class="block text-lg font-medium text-gray-700">Select Template:</label>
          <select id="qr-template-select" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
            <option value="">-- Select a Template --</option>
            <!-- Templates will be loaded here dynamically by renderExistingTemplates -->
          </select>
        </div>

        <div>
          <label for="log-type-select" class="block text-lg font-medium text-gray-700">Log Type:</label>
          <select id="log-type-select" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
            <option value="shared">Terra Code (Shared Log)</option>
            <option value="personal">Aura Code (Personal Log)</option>
          </select>
        </div>

        <!-- Public Item Data fields (conditionally displayed for Aura Codes) -->
        <div id="public-data-fields" class="hidden space-y-4 p-4 border border-purple-100 rounded-md bg-white">
          <h3 class="text-xl font-medium text-gray-700">Public Item Details (for Aura Codes):</h3>
          <div>
            <label for="public-title" class="block text-sm font-medium text-gray-700">Title:</label>
            <input type="text" id="public-title" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., Château Margaux 2015">
          </div>
          <div>
            <label for="public-description" class="block text-sm font-medium text-gray-700">Description:</label>
            <textarea id="public-description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="A brief description of the item"></textarea>
          </div>
          <div>
            <label for="public-image-url" class="block text-sm font-medium text-gray-700">Image URL:</label>
            <input type="url" id="public-image-url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="https://example.com/bottle.jpg">
          </div>
          <div>
            <label for="public-tasting-notes" class="block text-sm font-medium text-gray-700">Tasting Notes (for Wine/Food):</label>
            <textarea id="public-tasting-notes" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., Deep ruby, blackcurrant, cedar, elegant tannins"></textarea>
          </div>
          <div>
            <label for="public-website-link" class="block text-sm font-medium text-gray-700">Website Link:</label>
            <input type="url" id="public-website-link" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="https://example.com/product-page">
          </div>
        </div>

        <button type="submit" class="mt-8 w-full px-6 py-3 bg-purple-600 text-white font-bold rounded-md shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
          Save QR Code Configuration
        </button>
        <p id="configure-qr-status" class="mt-4 text-center text-sm text-gray-600"></p>
      </form>
    </div>

    <!-- NEW: Section for Managing Existing QR Configurations -->
    <div class="p-6 border border-teal-200 rounded-lg bg-teal-50">
      <h2 class="text-2xl font-semibold mb-6 text-teal-600">Existing QR Configurations</h2>
      <div id="existing-qr-list" class="space-y-4">
        <p class="text-center text-gray-500">Loading QR configurations...</p>
      </div>
    </div>

    <!-- Section for Managing Existing Templates (moved to bottom) -->
    <div class="mt-10 p-6 border border-gray-200 rounded-lg bg-gray-50">
      <h2 class="text-2xl font-semibold mb-6 text-gray-700">Existing Templates</h2>
      <div id="existing-templates-list" class="space-y-4">
        <p class="text-center text-gray-500">Loading templates...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com",
      messagingSenderId: "277809008742",
      appId: "1:277809008742:web:2586a2b821d8da8f969da7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const templatesRef = ref(db, "templates");
    const qrCodesRef = ref(db, "qr_codes");
    const publicItemsDataRef = ref(db, "public_items_data");

    // Get DOM elements for New Template Form
    const newTemplateForm = document.getElementById("new-template-form");
    const templateLabelInput = document.getElementById("template-label");
    const templateFieldsContainer = document.getElementById("template-fields-container");
    const addFieldBtn = document.getElementById("add-field-btn");
    const newTemplateStatus = document.getElementById("new-template-status");
    const existingTemplatesList = document.getElementById("existing-templates-list");

    // Get DOM elements for Configure QR Form
    const configureQrForm = document.getElementById("configure-qr-form");
    const qrIdInput = document.getElementById("qr-id-input");
    const qrTemplateSelect = document.getElementById("qr-template-select");
    const logTypeSelect = document.getElementById("log-type-select");
    const publicDataFields = document.getElementById("public-data-fields");
    const publicTitleInput = document.getElementById("public-title");
    const publicDescriptionInput = document.getElementById("public-description");
    const publicImageUrlInput = document.getElementById("public-image-url");
    const publicTastingNotesInput = document.getElementById("public-tasting-notes");
    const publicWebsiteLinkInput = document.getElementById("public-website-link");
    const configureQrStatus = document.getElementById("configure-qr-status");

    // NEW: Get DOM elements for Existing QR Configurations list
    const existingQrList = document.getElementById("existing-qr-list");

    let fieldCounter = 0; // To keep track of unique field IDs for templates

    // Function to add a new field input group to the template form
    function addNewField() {
      const fieldId = `field-${fieldCounter++}`;
      const fieldDiv = document.createElement("div");
      fieldDiv.className = "field-group p-3 border border-gray-200 rounded-md bg-gray-50 relative";
      fieldDiv.innerHTML = `
        <button type="button" class="remove-field-btn absolute top-2 right-2 text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
        <div class="mb-2">
          <label for="${fieldId}-name" class="block text-sm font-medium text-gray-700">Field Name:</label>
          <input type="text" id="${fieldId}-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., odometer">
        </div>
        <div class="mb-2">
          <label for="${fieldId}-type" class="block text-sm font-medium text-gray-700">Field Type:</label>
          <select id="${fieldId}-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            <option value="text">Text</option>
            <option value="number">Number (e.g., Currency, Quantity)</option>
            <option value="date">Date</option>
            <option value="multichoice">Multiple Choice</option>
          </select>
        </div>
        <div id="${fieldId}-options-container" class="hidden mt-2 p-2 border border-gray-200 rounded-md bg-white">
          <label class="block text-sm font-medium text-gray-700 mb-1">Multiple Choice Options (comma-separated):</label>
          <input type="text" id="${fieldId}-options" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Option1, Option2, Option3">
        </div>
      `;
      templateFieldsContainer.appendChild(fieldDiv);

      // Add event listener for type change to show/hide options
      const fieldTypeSelect = fieldDiv.querySelector(`#${fieldId}-type`);
      const optionsContainer = fieldDiv.querySelector(`#${fieldId}-options-container`);
      fieldTypeSelect.addEventListener("change", (event) => {
        if (event.target.value === "multichoice") {
          optionsContainer.classList.remove("hidden");
        } else {
          optionsContainer.classList.add("hidden");
        }
      });

      // Add event listener for remove button
      fieldDiv.querySelector(".remove-field-btn").addEventListener("click", () => {
        fieldDiv.remove();
      });
    }

    // Function to render existing templates
    async function renderExistingTemplates(templates) {
      existingTemplatesList.innerHTML = "";
      // Also populate the QR config template dropdown
      qrTemplateSelect.innerHTML = `<option value="">-- Select a Template --</option>`;

      if (!templates) {
        existingTemplatesList.innerHTML = `<p class="text-center text-gray-500">No templates found.</p>`;
        return;
      }

      Object.entries(templates).forEach(([key, template]) => {
        const templateDiv = document.createElement("div");
        templateDiv.className = "p-4 border border-gray-200 rounded-md bg-white shadow-sm flex justify-between items-center";
        templateDiv.innerHTML = `
          <div>
            <h3 class="text-lg font-semibold text-gray-800">${template.label || key}</h3>
            <p class="text-sm text-gray-500">Key: ${key}</p>
          </div>
          <button data-template-key="${key}" class="delete-template-btn px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
            Delete
          </button>
        `;
        existingTemplatesList.appendChild(templateDiv);

        // Populate QR config template dropdown
        const option = document.createElement("option");
        option.value = key;
        option.innerText = template.label || key;
        qrTemplateSelect.appendChild(option);
      });

      // Add event listeners for delete buttons
      existingTemplatesList.querySelectorAll(".delete-template-btn").forEach(button => {
        button.addEventListener("click", async (event) => {
          const templateKey = event.target.dataset.templateKey;
          if (confirm(`Are you sure you want to delete the template "${templateKey}"? This action cannot be undone.`)) {
            try {
              await remove(ref(db, `templates/${templateKey}`));
              console.log(`Template "${templateKey}" deleted successfully.`);
            } catch (error) {
              console.error("Error deleting template:", error);
              alert("Failed to delete template: " + error.message);
            }
          }
        });
      });
    }

    // NEW: Function to render existing QR configurations
    async function renderExistingQrConfigs(qrConfigs) {
      existingQrList.innerHTML = "";
      if (!qrConfigs) {
        existingQrList.innerHTML = `<p class="text-center text-gray-500">No QR codes configured yet.</p>`;
        return;
      }

      // Fetch all templates once to get their labels
      const templatesSnap = await get(templatesRef);
      const templates = templatesSnap.val() || {};

      Object.entries(qrConfigs).forEach(([qrId, config]) => {
        const templateLabel = templates[config.template]?.label || config.template || 'N/A';
        const logTypeDisplay = config.log_scope === 'personal' ? 'Aura Code (Personal Log)' : 'Terra Code (Shared Log)';

        const qrDiv = document.createElement("div");
        qrDiv.className = "p-4 border border-gray-200 rounded-md bg-white shadow-sm flex justify-between items-center";
        qrDiv.innerHTML = `
          <div>
            <h3 class="text-lg font-semibold text-gray-800">QR ID: ${qrId}</h3>
            <p class="text-sm text-gray-500">Template: ${templateLabel}</p>
            <p class="text-sm text-gray-500">Log Type: ${logTypeDisplay}</p>
          </div>
          <div class="flex space-x-2">
            <button data-qr-id="${qrId}" class="load-qr-btn px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
              Load for Edit
            </button>
            <button data-qr-id="${qrId}" class="delete-qr-btn px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
              Delete
            </button>
          </div>
        `;
        existingQrList.appendChild(qrDiv);
      });

      // Add event listeners for Load and Delete QR buttons
      existingQrList.querySelectorAll(".load-qr-btn").forEach(button => {
        button.addEventListener("click", async (event) => {
          const qrId = event.target.dataset.qrId;
          await loadQrConfigIntoForm(qrId);
        });
      });

      existingQrList.querySelectorAll(".delete-qr-btn").forEach(button => {
        button.addEventListener("click", async (event) => {
          const qrId = event.target.dataset.qrId;
          if (confirm(`Are you sure you want to delete the QR configuration for "${qrId}"? This will also delete any associated public item data. This action cannot be undone.`)) {
            try {
              await remove(ref(db, `qr_codes/${qrId}`));
              await remove(ref(db, `public_items_data/${qrId}`)); // Also delete public data
              console.log(`QR configuration and public data for "${qrId}" deleted successfully.`);
              configureQrForm.reset(); // Clear form after delete
              qrIdInput.readOnly = false; // Make QR ID editable again
              publicDataFields.classList.add('hidden'); // Hide public fields
              configureQrStatus.textContent = `QR configuration for "${qrId}" deleted.`;
              configureQrStatus.className = "mt-4 text-center text-sm text-green-600 font-bold";
              setTimeout(() => configureQrStatus.textContent = "", 3000);
            } catch (error) {
              console.error("Error deleting QR configuration:", error);
              alert("Failed to delete QR configuration: " + error.message);
            }
          }
        });
      });
    }

    // NEW: Function to load existing QR config into the form for editing
    async function loadQrConfigIntoForm(qrId) {
      qrIdInput.value = qrId;
      qrIdInput.readOnly = true; // Make QR ID read-only when editing

      const qrConfigSnap = await get(ref(db, `qr_codes/${qrId}`));
      const qrConfig = qrConfigSnap.val();

      if (qrConfig) {
        qrTemplateSelect.value = qrConfig.template || '';
        logTypeSelect.value = qrConfig.log_scope || 'shared';
        // Trigger change to show/hide public data fields
        logTypeSelect.dispatchEvent(new Event('change'));

        const publicDataSnap = await get(ref(db, `public_items_data/${qrId}`));
        const publicData = publicDataSnap.val();
        if (publicData) {
          publicTitleInput.value = publicData.title || '';
          publicDescriptionInput.value = publicData.description || '';
          publicImageUrlInput.value = publicData.image_url || '';
          publicTastingNotesInput.value = publicData.tasting_notes || '';
          publicWebsiteLinkInput.value = publicData.website_link || '';
        } else {
          // Clear public data fields if no existing data
          publicTitleInput.value = '';
          publicDescriptionInput.value = '';
          publicImageUrlInput.value = '';
          publicTastingNotesInput.value = '';
          publicWebsiteLinkInput.value = '';
        }
      } else {
        // If QR ID does not exist in qr_codes, clear form for new entry
        configureQrForm.reset();
        publicDataFields.classList.add('hidden'); // Ensure hidden by default
        qrIdInput.readOnly = false; // Make sure it's editable for new entry
      }
      configureQrStatus.textContent = ""; // Clear status message
    }

    // Main function to initialize and handle events
    async function main() {
      // Initial field for new template form
      addNewField();

      // Event listener for "Add New Field" button
      addFieldBtn.addEventListener("click", addNewField);

      // Event listener for new template form submission
      newTemplateForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        newTemplateStatus.textContent = "Saving template...";
        newTemplateStatus.className = "mt-4 text-center text-sm text-gray-600";

        const templateLabel = templateLabelInput.value.trim();
        // Auto-generate template key from display label
        const templateName = templateLabel.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

        if (!templateLabel) {
          newTemplateStatus.textContent = "Error: Display Label is required.";
          newTemplateStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
          return;
        }
        if (!templateName) { // Fallback if label results in empty key
          newTemplateStatus.textContent = "Error: Could not generate a valid template key from the display label. Please use alphanumeric characters.";
          newTemplateStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
          return;
        }


        const fields = {};
        const fieldGroups = templateFieldsContainer.querySelectorAll(".field-group");
        
        fieldGroups.forEach((group, index) => {
          const fieldName = group.querySelector("input[type='text']").value.trim();
          const fieldType = group.querySelector("select").value;
          
          if (fieldName) {
            const field = { name: fieldName, type: fieldType };
            if (fieldType === "multichoice") {
              const optionsInput = group.querySelector("input[id$='-options']");
              if (optionsInput && optionsInput.value.trim()) {
                field.options = optionsInput.value.split(',').map(opt => opt.trim()).filter(opt => opt.length > 0);
              } else {
                console.warn(`Multiple Choice field '${fieldName}' has no options. Treating as text.`);
                field.type = "text"; // Fallback to text if no options
                delete field.options;
              }
            }
            fields[index] = field; // Use index as key to match Firebase structure
          }
        });

        if (Object.keys(fields).length === 0) {
          newTemplateStatus.textContent = "Error: At least one field is required for the template.";
          newTemplateStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
          return;
        }

        const newTemplateData = {
          label: templateLabel,
          fields: fields
        };

        try {
          // Check if template name already exists
          const existingTemplateSnap = await get(ref(db, `templates/${templateName}`));
          if (existingTemplateSnap.exists()) {
            newTemplateStatus.textContent = `Error: Template with key "${templateName}" already exists. Please choose a different Display Label.`;
            newTemplateStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
            return;
          }

          await set(ref(db, `templates/${templateName}`), newTemplateData);
          newTemplateStatus.textContent = `Template "${templateLabel}" (Key: "${templateName}") saved successfully!`;
          newTemplateStatus.className = "mt-4 text-center text-sm text-green-600 font-bold";
          newTemplateForm.reset(); // Clear form
          templateFieldsContainer.innerHTML = ''; // Clear fields
          fieldCounter = 0; // Reset counter
          addNewField(); // Add one empty field for convenience
        } catch (error) {
          console.error("Error saving template:", error);
          newTemplateStatus.textContent = `Error saving template: ${error.message}`;
          newTemplateStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
        }
      });

      // NEW: Event listener for Log Type dropdown to show/hide public data fields
      logTypeSelect.addEventListener('change', () => {
        if (logTypeSelect.value === 'personal') {
          publicDataFields.classList.remove('hidden');
        } else {
          publicDataFields.classList.add('hidden');
          // Clear public data fields when hidden to prevent stale data on re-show
          publicTitleInput.value = '';
          publicDescriptionInput.value = '';
          publicImageUrlInput.value = '';
          publicTastingNotesInput.value = '';
          publicWebsiteLinkInput.value = '';
        }
      });

      // NEW: Event listener for Configure QR form submission
      configureQrForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        configureQrStatus.textContent = "Saving QR configuration...";
        configureQrStatus.className = "mt-4 text-center text-sm text-gray-600";

        const qrId = qrIdInput.value.trim();
        const selectedTemplate = qrTemplateSelect.value;
        const selectedLogType = logTypeSelect.value;

        if (!qrId || !selectedTemplate || !selectedLogType) {
          configureQrStatus.textContent = "Error: QR Code ID, Template, and Log Type are required.";
          configureQrStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
          return;
        }

        const qrConfigData = {
          template: selectedTemplate,
          log_scope: selectedLogType
        };

        const publicData = {};
        if (selectedLogType === 'personal') {
          publicData.title = publicTitleInput.value.trim();
          publicData.description = publicDescriptionInput.value.trim();
          publicData.image_url = publicImageUrlInput.value.trim();
          publicData.tasting_notes = publicTastingNotesInput.value.trim();
          publicData.website_link = publicWebsiteLinkInput.value.trim();
        }

        try {
          // Check if QR ID already exists for overwrite confirmation
          const existingQrSnap = await get(ref(db, `qr_codes/${qrId}`));
          if (existingQrSnap.exists()) {
            if (!confirm(`QR Code ID "${qrId}" already exists. Do you want to overwrite its configuration and public data?`)) {
              configureQrStatus.textContent = "Operation cancelled.";
              configureQrStatus.className = "mt-4 text-center text-sm text-gray-600";
              return;
            }
          }

          await set(ref(db, `qr_codes/${qrId}`), qrConfigData);
          
          if (selectedLogType === 'personal' && Object.keys(publicData).length > 0) {
            await set(ref(db, `public_items_data/${qrId}`), publicData);
          } else {
            // If switched from personal to shared, or no public data for personal, remove old public data
            await remove(ref(db, `public_items_data/${qrId}`));
          }

          configureQrStatus.textContent = `QR Code "${qrId}" configured successfully!`;
          configureQrStatus.className = "mt-4 text-center text-sm text-green-600 font-bold";
          configureQrForm.reset(); // Clear form
          qrIdInput.readOnly = false; // Make QR ID editable again
          publicDataFields.classList.add('hidden'); // Hide public fields
          setTimeout(() => configureQrStatus.textContent = "", 3000);
        } catch (error) {
          console.error("Error saving QR configuration:", error);
          configureQrStatus.textContent = `Error saving QR configuration: ${error.message}`;
          configureQrStatus.className = "mt-4 text-center text-sm text-red-600 font-bold";
        }
      });

      // Listen for real-time updates to templates and re-render the list
      onValue(templatesRef, (snapshot) => {
        const templates = snapshot.val();
        renderExistingTemplates(templates);
      }, (error) => {
        console.error("Error fetching existing templates:", error);
        existingTemplatesList.innerHTML = `<p class="text-center text-red-600">Error loading templates: ${error.message}</p>`;
      });

      // NEW: Listen for real-time updates to QR configurations and re-render the list
      onValue(qrCodesRef, (snapshot) => {
        const qrConfigs = snapshot.val();
        renderExistingQrConfigs(qrConfigs);
      }, (error) => {
        console.error("Error fetching existing QR configurations:", error);
        existingQrList.innerHTML = `<p class="text-center text-red-600">Error loading QR configurations: ${error.message}</p>`;
      });
    }

    main();
  </script>
</body>
</html>
